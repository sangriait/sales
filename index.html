<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resource Management System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f5f7fa; }
    
    .container { display: flex; height: 100vh; }
    
    .sidebar { width: 240px; background: #2c3e50; color: white; padding: 20px; }
    .sidebar h1 { font-size: 1.5rem; margin-bottom: 30px; }
    .nav-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .nav-item:hover { background: #34495e; }
    .nav-item.active { background: #4f46e5; }
    
    .main-content { flex: 1; overflow-y: auto; padding: 30px; }
    
    .view { display: none; }
    .view-active { display: block; }
    
    .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    
    .subnav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
    .subnav-item { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
    .subnav-item:hover { background: #f3f4f6; }
    .subnav-item.subnav-active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
    
    .subview { display: none; }
    .subview-active { display: block; }
    
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #dee2e6; }
    td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
    
    .table-button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
    .table-button:hover { opacity: 0.8; }
    
    .status-pill { padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }
    .status-pill--pending { background: #fef3c7; color: #92400e; }
    .status-pill--progress { background: #dbeafe; color: #1e40af; }
    .status-pill--completed { background: #d1fae5; color: #065f46; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 14px; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #4f46e5; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h1>üìä ResHub</h1>
      <div class="nav-item active" data-view="dashboard">üè† Dashboard</div>
      <div class="nav-item" data-view="operations">‚öôÔ∏è Operations</div>
      <div class="nav-item" data-view="sales">üí∞ Sales</div>
      <div class="nav-item" data-view="shares">üì§ Shares</div>
    </div>

    <div class="main-content">
      <!-- DASHBOARD VIEW -->
      <div id="view-dashboard" class="view view-active">
        <h1 style="margin-bottom: 20px;">Dashboard</h1>
        <div id="dashboard-stats"></div>
        <div id="dashboard-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
          <div class="card">
            <h3 style="margin-bottom: 15px;">Task Status Distribution</h3>
            <canvas id="statusChart" style="max-height: 250px;"></canvas>
          </div>
          <div class="card">
            <h3 style="margin-bottom: 15px;">Resources by Department</h3>
            <canvas id="departmentChart" style="max-height: 250px;"></canvas>
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <h3 style="margin-bottom: 15px;">Recent Activity</h3>
          <div id="activity-feed"></div>
        </div>
      </div>

      <!-- OPERATIONS VIEW -->
      <div id="view-operations" class="view">
        <h1 style="margin-bottom: 20px;">Operations</h1>
        <div class="subnav">
          <div class="subnav-item subnav-active" data-subview="subview-resources">Resources</div>
          <div class="subnav-item" data-subview="subview-projects">Projects</div>
          <div class="subnav-item" data-subview="subview-tasks">Tasks</div>
          <div class="subnav-item" data-subview="subview-assignments">Assignments</div>
        </div>

        <!-- Resources Subview -->
        <div id="subview-resources" class="subview subview-active">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2>All Resources</h2>
              <button class="btn btn-primary" id="btn-add-resource">+ Add Resource</button>
            </div>
            <table id="table-resources">
              <thead>
                <tr>
                  <th>NAME</th>
                  <th>EMAIL</th>
                  <th>DEPARTMENT</th>
                  <th>ROLE</th>
                  <th>ACTIONS</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Projects Subview -->
        <div id="subview-projects" class="subview">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2>All Projects</h2>
              <button class="btn btn-primary" id="btn-add-project">+ Add Project</button>
            </div>
            <table id="table-projects">
              <thead>
                <tr>
                  <th>PROJECT NAME</th>
                  <th>STATUS</th>
                  <th>START DATE</th>
                  <th>END DATE</th>
                  <th>ACTIONS</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Tasks Subview -->
        <div id="subview-tasks" class="subview">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2>All Tasks</h2>
              <button class="btn btn-primary" id="btn-add-task">+ Add Task</button>
            </div>
            <table id="table-tasks">
              <thead>
                <tr>
                  <th>TASK NAME</th>
                  <th>PROJECT</th>
                  <th>STATUS</th>
                  <th>PRIORITY</th>
                  <th>DUE DATE</th>
                  <th>ACTIONS</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Assignments Subview -->
        <div id="subview-assignments" class="subview">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2>All Assignments</h2>
              <button class="btn btn-primary" id="btn-add-assignment">+ Add Assignment</button>
            </div>
            <table id="table-assignments">
              <thead>
                <tr>
                  <th>RESOURCE</th>
                  <th>TASK</th>
                  <th>PROJECT</th>
                  <th>ASSIGNED DATE</th>
                  <th>ACTIONS</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- SALES VIEW -->
      <div id="view-sales" class="view">
        <h1 style="margin-bottom: 20px;">Sales Estimates</h1>
        <div id="sales-body"></div>
      </div>

      <!-- SHARES VIEW -->
      <div id="view-shares" class="view">
        <div class="card">
          <h2 style="margin-bottom: 20px;">Share Data</h2>
          <div class="form-group">
            <label>Share Type</label>
            <select id="share-type">
              <option value="resource">Resource</option>
              <option value="project">Project</option>
            </select>
          </div>
          <div class="form-group">
            <label>Select Individual</label>
            <select id="select-individual-resource"></select>
          </div>
          <button class="btn btn-primary" id="btn-share">Share Selected Data</button>
          <div style="margin-top: 30px;">
            <h3>Shared Items</h3>
            <div id="shares-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="modal-resource" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;">Add Resource</h2>
      <form id="form-resource">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" id="resource-name" required>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="resource-email" required>
        </div>
        <div class="form-group">
          <label>Department *</label>
          <select id="resource-department" required>
            <option value="">Select Department</option>
            <option value="Engineering">Engineering</option>
            <option value="Design">Design</option>
            <option value="Marketing">Marketing</option>
            <option value="Sales">Sales</option>
            <option value="HR">HR</option>
          </select>
        </div>
        <div class="form-group">
          <label>Role *</label>
          <input type="text" id="resource-role" required>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('modal-resource')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Resource</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-project" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;">Add Project</h2>
      <form id="form-project">
        <div class="form-group">
          <label>Project Name *</label>
          <input type="text" id="project-name" required>
        </div>
        <div class="form-group">
          <label>Status *</label>
          <select id="project-status" required>
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
        </div>
        <div class="form-group">
          <label>Start Date</label>
          <input type="date" id="project-start">
        </div>
        <div class="form-group">
          <label>End Date</label>
          <input type="date" id="project-end">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('modal-project')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Project</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-task" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;">Add Task</h2>
      <form id="form-task">
        <div class="form-group">
          <label>Task Name *</label>
          <input type="text" id="task-name" required>
        </div>
        <div class="form-group">
          <label>Project *</label>
          <select id="task-project" required>
            <option value="">Select Project</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status *</label>
          <select id="task-status" required>
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
        </div>
        <div class="form-group">
          <label>Priority *</label>
          <select id="task-priority" required>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="form-group">
          <label>Due Date</label>
          <input type="date" id="task-due">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('modal-task')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Task</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-assignment" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;">Add Assignment</h2>
      <form id="form-assignment">
        <div class="form-group">
          <label>Resource *</label>
          <select id="select-assign-resource" required>
            <option value="">Select Resource</option>
          </select>
        </div>
        <div class="form-group">
          <label>Task *</label>
          <select id="assignment-task" required>
            <option value="">Select Task</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('modal-assignment')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Assignment</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // State management
    const state = {
      resources: [],
      projects: [],
      tasks: [],
      assignments: [],
      shares: [],
      activity: [],
      estimates: [],
    };

    let idCounter = 1;
    const nextId = () => String(idCounter++);
    let statusChart, departmentChart;

    // Utility functions
    function addActivity(message, meta) {
      const entry = { id: nextId(), message, meta, timestamp: new Date() };
      state.activity.unshift(entry);
      renderActivity();
    }

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return "-";
      return `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}/${d.getFullYear()}`;
    }

    function calculateOnTimePercentage(items) {
      if (!items.length) return 0;
      const completed = items.filter((a) => a.status === "completed");
      if (!completed.length) return 0;
      const now = new Date();
      const onTime = completed.filter((a) => {
        if (!a.dueDate) return true;
        const due = new Date(a.dueDate);
        return a.completedAt && new Date(a.completedAt) <= due && new Date(a.completedAt) <= now;
      });
      return Math.round((onTime.length / completed.length) * 100);
    }

    // Modal functions
    function openModal(id) {
      document.getElementById(id).classList.add('modal-active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('modal-active');
    }
    window.closeModal = closeModal;

    // Navigation
    function setupMainNavigation() {
      const navButtons = document.querySelectorAll(".nav-item");
      const views = document.querySelectorAll(".view");

      navButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.view;
          navButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          views.forEach((v) => v.classList.remove("view-active"));
          const viewEl = document.getElementById(`view-${target}`);
          if (viewEl) viewEl.classList.add("view-active");
          if (target === 'dashboard') renderDashboard();
        });
      });
    }

    function setupOperationsSubnav() {
      const subnavButtons = document.querySelectorAll(".subnav-item");
      const subviews = document.querySelectorAll(".subview");

      subnavButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.subview;
          subnavButtons.forEach((b) => b.classList.remove("subnav-active"));
          btn.classList.add("subnav-active");
          subviews.forEach((v) => v.classList.remove("subview-active"));
          const viewEl = document.getElementById(target);
          if (viewEl) viewEl.classList.add("subview-active");
        });
      });
    }

    // RESOURCES
    function renderResources() {
      const tbody = document.querySelector("#table-resources tbody");
      const selectAssign = document.getElementById("select-assign-resource");
      const selectIndividual = document.getElementById("select-individual-resource");

      tbody.innerHTML = state.resources.length === 0 ? 
        '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">No resources found. Click "+ Add Resource" to create one.</td></tr>' :
        state.resources.map(r => `
          <tr>
            <td>${r.name}</td>
            <td>${r.email}</td>
            <td>${r.department}</td>
            <td>${r.role}</td>
            <td>
              <button class="table-button" style="background: #dc3545; color: white;" onclick="deleteResource('${r.id}')">Delete</button>
            </td>
          </tr>
        `).join('');

      if (selectAssign) {
        selectAssign.innerHTML = '<option value="">Select Resource</option>' +
          state.resources.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
      }

      if (selectIndividual) {
        selectIndividual.innerHTML = '<option value="">Select Individual</option>' +
          state.resources.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
      }
    }

    function deleteResource(id) {
      if (confirm('Are you sure you want to delete this resource?')) {
        const resource = state.resources.find(r => r.id === id);
        state.resources = state.resources.filter(r => r.id !== id);
        state.assignments = state.assignments.filter(a => a.resourceId !== id);
        addActivity(`Deleted resource: ${resource.name}`, "Resources");
        renderResources();
        renderAssignments();
      }
    }
    window.deleteResource = deleteResource;

    // PROJECTS
    function renderProjects() {
      const tbody = document.querySelector("#table-projects tbody");
      const selectTask = document.getElementById("task-project");

      tbody.innerHTML = state.projects.length === 0 ?
        '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">No projects found. Click "+ Add Project" to create one.</td></tr>' :
        state.projects.map(p => `
          <tr>
            <td>${p.name}</td>
            <td><span class="status-pill status-pill--${p.status === 'pending' ? 'pending' : p.status === 'in-progress' ? 'progress' : 'completed'}">${p.status}</span></td>
            <td>${formatDate(p.startDate)}</td>
            <td>${formatDate(p.endDate)}</td>
            <td>
              <button class="table-button" style="background: #dc3545; color: white;" onclick="deleteProject('${p.id}')">Delete</button>
            </td>
          </tr>
        `).join('');

      if (selectTask) {
        selectTask.innerHTML = '<option value="">Select Project</option>' +
          state.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      }
    }

    function deleteProject(id) {
      if (confirm('Are you sure you want to delete this project?')) {
        const project = state.projects.find(p => p.id === id);
        state.projects = state.projects.filter(p => p.id !== id);
        state.tasks = state.tasks.filter(t => t.projectId !== id);
        addActivity(`Deleted project: ${project.name}`, "Projects");
        renderProjects();
        renderTasks();
      }
    }
    window.deleteProject = deleteProject;

    // TASKS
    function renderTasks() {
      const tbody = document.querySelector("#table-tasks tbody");
      const selectAssignTask = document.getElementById("assignment-task");

      tbody.innerHTML = state.tasks.length === 0 ?
        '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6c757d;">No tasks found. Click "+ Add Task" to create one.</td></tr>' :
        state.tasks.map(t => {
          const project = state.projects.find(p => p.id === t.projectId);
          return `
            <tr>
              <td>${t.name}</td>
              <td>${project ? project.name : 'N/A'}</td>
              <td><span class="status-pill status-pill--${t.status === 'pending' ? 'pending' : t.status === 'in-progress' ? 'progress' : 'completed'}">${t.status}</span></td>
              <td>${t.priority}</td>
              <td>${formatDate(t.dueDate)}</td>
              <td>
                <button class="table-button" style="background: #dc3545; color: white;" onclick="deleteTask('${t.id}')">Delete</button>
              </td>
            </tr>
          `;
        }).join('');

      if (selectAssignTask) {
        selectAssignTask.innerHTML = '<option value="">Select Task</option>' +
          state.tasks.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      }
    }

    function deleteTask(id) {
      if (confirm('Are you sure you want to delete this task?')) {
        const task = state.tasks.find(t => t.id === id);
        state.tasks = state.tasks.filter(t => t.id !== id);
        state.assignments = state.assignments.filter(a => a.taskId !== id);
        addActivity(`Deleted task: ${task.name}`, "Tasks");
        renderTasks();
        renderAssignments();
      }
    }
    window.deleteTask = deleteTask;

    // ASSIGNMENTS
    function renderAssignments() {
      const tbody = document.querySelector("#table-assignments tbody");

      tbody.innerHTML = state.assignments.length === 0 ?
        '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">No assignments found. Click "+ Add Assignment" to create one.</td></tr>' :
        state.assignments.map(a => {
          const resource = state.resources.find(r => r.id === a.resourceId);
          const task = state.tasks.find(t => t.id === a.taskId);
          const project = task ? state.projects.find(p => p.id === task.projectId) : null;
          return `
            <tr>
              <td>${resource ? resource.name : 'N/A'}</td>
              <td>${task ? task.name : 'N/A'}</td>
              <td>${project ? project.name : 'N/A'}</td>
              <td>${formatDate(a.assignedDate)}</td>
              <td>
                <button class="table-button" style="background: #dc3545; color: white;" onclick="deleteAssignment('${a.id}')">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
    }

    function deleteAssignment(id) {
      if (confirm('Are you sure you want to delete this assignment?')) {
        state.assignments = state.assignments.filter(a => a.id !== id);
        addActivity(`Deleted assignment`, "Assignments");
        renderAssignments();
      }
    }
    window.deleteAssignment = deleteAssignment;

    // DASHBOARD
    function renderDashboard() {
      const statsContainer = document.getElementById('dashboard-stats');
      statsContainer.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
          <div class="card" style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #4f46e5;">${state.resources.length}</div>
            <div style="color: #6c757d; margin-top: 5px;">Total Resources</div>
          </div>
          <div class="card" style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #4f46e5;">${state.projects.length}</div>
            <div style="color: #6c757d; margin-top: 5px;">Active Projects</div>
          </div>
          <div class="card" style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #4f46e5;">${state.tasks.length}</div>
            <div style="color: #6c757d; margin-top: 5px;">Total Tasks</div>
          </div>
          <div class="card" style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #4f46e5;">${state.assignments.length}</div>
            <div style="color: #6c757d; margin-top: 5px;">Assignments</div>
          </div>
        </div>
      `;
      renderCharts();
    }

    function renderCharts() {
      // Status Chart
      const statusCtx = document.getElementById('statusChart');
      if (statusChart) statusChart.destroy();
      
      const statusCounts = {
        pending: state.tasks.filter(t => t.status === 'pending').length,
        'in-progress': state.tasks.filter(t => t.status === 'in-progress').length,
        completed: state.tasks.filter(t => t.status === 'completed').length
      };

      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Pending', 'In Progress', 'Completed'],
          datasets: [{
            data: [statusCounts.pending, statusCounts['in-progress'], statusCounts.completed],
            backgroundColor: ['#fef3c7', '#dbeafe', '#d1fae5']
          }]
        },
        options: { responsive: true, maintainAspectRatio: true }
      });

      // Department Chart
      const deptCtx = document.getElementById('departmentChart');
      if (departmentChart) departmentChart.destroy();

      const deptCounts = {};
      state.resources.forEach(r => {
        deptCounts[r.department] = (deptCounts[r.department] || 0) + 1;
      });

      departmentChart = new Chart(deptCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(deptCounts),
          datasets: [{
            label: 'Resources',
            data: Object.values(deptCounts),
            backgroundColor: '#4f46e5'
          }]
        },
        options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
      });
    }

    function renderActivity() {
      const feed = document.getElementById('activity-feed');
      if (!feed) return;
      feed.innerHTML = state.activity.length === 0 ?
        '<p style="color: #6c757d; text-align: center; padding: 20px;">No recent activity</p>' :
        state.activity.slice(0, 10).map(a => `
          <div style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
            <div style="font-weight: 600;">${a.message}</div>
            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
              ${a.meta} ‚Ä¢ ${new Date(a.timestamp).toLocaleString()}
            </div>
          </div>
        `).join('');
    }

    // SALES ESTIMATES
    function renderSalesEstimates() {
      const container = document.getElementById("sales-body");
      if (!container) return;

      container.innerHTML = `
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">All Estimates</h2>
            <button class="btn btn-primary" id="btn-create-estimate">+ New Estimate</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>DATE</th>
                <th>ESTIMATE NUMBER</th>
                <th>REFERENCE NUMBER</th>
                <th>CUSTOMER NAME</th>
                <th>STATUS</th>
                <th style="text-align: right;">AMOUNT</th>
              </tr>
            </thead>
            <tbody>
              ${state.estimates.length === 0 ? `
                <tr><td colspan="6" style="text-align: center; padding: 40px; color: #6c757d;">
                  No estimates found. Click "+ New Estimate" to create one.
                </td></tr>
              ` : state.estimates.map(est => `
                <tr>
                  <td>${formatDate(est.date)}</td>
                  <td style="color: #4f46e5; cursor: pointer;" class="view-estimate" data-id="${est.id}">
                    ${est.number} üëÅÔ∏è
                  </td>
                  <td>${est.reference || '-'}</td>
                  <td>${est.customerName}</td>
                  <td><span class="status-pill status-pill--${est.status === 'DRAFT' ? 'pending' : 'completed'}">
                    ${est.status}
                  </span></td>
                  <td style="text-align: right;">‚Çπ${est.amount.toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById("btn-create-estimate")?.addEventListener("click", showEstimateForm);
      document.querySelectorAll(".view-estimate").forEach(el => {
        el.addEventListener("click", (e) => viewEstimate(e.target.closest('.view-estimate').dataset.id));
      });
    }

    function showEstimateForm() {
      const container = document.getElementById("sales-body");
      container.innerHTML = `
        <div class="card" style="max-width: 1200px; margin: 0 auto;">
          <h2 style="margin-bottom: 20px;">New Estimate</h2>
          <form id="estimate-form">
            <div class="form-group">
              <label>Customer Name *</label>
              <select id="est-customer" required>
                <option value="">Select Customer</option>
                ${state.resources.map(r => `<option value="${r.id}">${r.name} - ${r.email}</option>`).join('')}
              </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div class="form-group">
                <label>Estimate# *</label>
                <input type="text" id="est-number" value="EST-${String(Date.now()).slice(-5)}" required>
              </div>
              <div class="form-group">
                <label>Reference#</label>
                <input type="text" id="est-reference">
              </div>
              <div class="form-group">
                <label>Estimate Date *</label>
                <input type="date" id="est-date" value="${new Date().toISOString().slice(0, 10)}" required>
              </div>
            </div>
            <div style="margin-bottom: 20px;">
              <h4 style="margin-bottom: 12px;">Item Table</h4>
              <div style="overflow-x: auto;">
                <table style="border: 1px solid #dee2e6;">
                  <thead>
                    <tr style="background: #f8f9fa;">
                      <th>ITEM DETAILS</th>
                      <th style="width: 100px;">QUANTITY</th>
                      <th style="width: 120px;">RATE</th>
                      <th style="width: 100px;">DISCOUNT</th>
                      <th style="width: 80px;">TAX %</th>
                      <th style="width: 120px;">AMOUNT</th>
                      <th style="width: 50px;"></th>
                    </tr>
                  </thead>
                  <tbody id="items-tbody"></tbody>
                </table>
              </div>
              <button type="button" id="add-item-btn" class="btn btn-primary" style="margin-top: 10px;">+ Add New Row</button>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
              <div style="width: 400px;">
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                  <span>Sub Total</span>
                  <span id="subtotal-display">‚Çπ0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                  <span>Shipping Charges</span>
                  <input type="number" id="shipping-charges" value="0" min="0" step="0.01" style="width: 120px; padding: 4px 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                  <span>Adjustment</span>
                  <input type="number" id="adjustment" value="0" step="0.01" style="width: 120px; padding: 4px 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; font-size: 18px; font-weight: bold; background: #f8f9fa; margin-top: 4px;">
                  <span>Total</span>
                  <span id="total-display">‚Çπ0.00</span>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Terms & Conditions</label>
              <textarea id="est-terms" rows="4" placeholder="Enter terms and conditions"></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: space-between;">
              <button type="button" id="cancel-estimate-btn" class="btn btn-secondary">Cancel</button>
              <div style="display: flex; gap: 10px;">
                <button type="button" id="save-draft-btn" class="btn" style="background: #f8f9fa; color: #333; border: 1px solid #dee2e6;">Save as Draft</button>
                <button type="submit" class="btn btn-primary">Save and Send</button>
              </div>
            </div>
          </form>
        </div>
      `;

      renderEstimateItems([{ description: '', quantity: 1, rate: 0, discount: 0, tax: 0 }]);
      document.getElementById("add-item-btn").addEventListener("click", addEstimateItem);
      document.getElementById("cancel-estimate-btn").addEventListener("click", renderSalesEstimates);
      document.getElementById("save-draft-btn").addEventListener("click", () => saveEstimate(true));
      document.getElementById("estimate-form").addEventListener("submit", (e) => {
        e.preventDefault();
        saveEstimate(false);
      });
      document.getElementById("items-tbody").addEventListener("input", calculateEstimateTotals);
      document.getElementById("shipping-charges").addEventListener("input", calculateEstimateTotals);
      document.getElementById("adjustment").addEventListener("input", calculateEstimateTotals);
      calculateEstimateTotals();
    }

    function renderEstimateItems(items) {
      const tbody = document.getElementById("items-tbody");
      tbody.innerHTML = items.map((item, i) => `
        <tr>
          <td><input type="text" class="item-description" data-index="${i}" value="${item.description || ''}" style="width: 100%; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px;"></td>
          <td><input type="number" class="item-quantity" data-index="${i}" value="${item.quantity || 1}" min="1" style="width: 100%; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px;"></td>
          <td><input type="number" class="item-rate" data-index="${i}" value="${item.rate || 0}" min="0" step="0.01" style="width: 100%; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px;"></td>
          <td><input type="number" class="item-discount" data-index="${i}" value="${item.discount || 0}" min="0" step="0.01" style="width: 100%; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px;"></td>
          <td><input type="number" class="item-tax" data-index="${i}" value="${item.tax || 0}" min="0" max="100" step="0.01" style="width: 100%; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px;"></td>
          <td class="item-amount" style="font-weight: 600;">‚Çπ0.00</td>
          <td style="text-align: center;">
            <button type="button" class="remove-item-btn" data-index="${i}" style="color: #dc3545; background: none; border: none; cursor: pointer; font-size: 18px;">‚úï</button>
          </td>
        </tr>
      `).join('');
      document.querySelectorAll(".remove-item-btn").forEach(btn => {
        btn.addEventListener("click", (e) => removeEstimateItem(parseInt(e.target.dataset.index)));
      });
    }

    function addEstimateItem() {
      const tbody = document.getElementById("items-tbody");
      const items = Array.from(tbody.querySelectorAll("tr")).map(tr => ({
        description: tr.querySelector(".item-description").value,
        quantity: parseFloat(tr.querySelector(".item-quantity").value) || 1,
        rate: parseFloat(tr.querySelector(".item-rate").value) || 0,
        discount: parseFloat(tr.querySelector(".item-discount").value) || 0,
        tax: parseFloat(tr.querySelector(".item-tax").value) || 0
      }));
      items.push({ description: '', quantity: 1, rate: 0, discount: 0, tax: 0 });
      renderEstimateItems(items);
      calculateEstimateTotals();
    }

    function removeEstimateItem(index) {
      const tbody = document.getElementById("items-tbody");
      const items = Array.from(tbody.querySelectorAll("tr")).map(tr => ({
        description: tr.querySelector(".item-description").value,
        quantity: parseFloat(tr.querySelector(".item-quantity").value) || 1,
        rate: parseFloat(tr.querySelector(".item-rate").value) || 0,
        discount: parseFloat(tr.querySelector(".item-discount").value) || 0,
        tax: parseFloat(tr.querySelector(".item-tax").value) || 0
      }));
      if (items.length > 1) {
        items.splice(index, 1);
        renderEstimateItems(items);
        calculateEstimateTotals();
      } else {
        alert("You must have at least one item in the estimate.");
      }
    }

    function calculateEstimateTotals() {
      const tbody = document.getElementById("items-tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      let subtotal = 0;
      
      rows.forEach(row => {
        const qty = parseFloat(row.querySelector(".item-quantity").value) || 0;
        const rate = parseFloat(row.querySelector(".item-rate").value) || 0;
        const discount = parseFloat(row.querySelector(".item-discount").value) || 0;
        const tax = parseFloat(row.querySelector(".item-tax").value) || 0;
        const itemTotal = (qty * rate - discount) * (1 + tax / 100);
        row.querySelector(".item-amount").textContent = `‚Çπ${itemTotal.toFixed(2)}`;
        subtotal += itemTotal;
      });
      
      const shipping = parseFloat(document.getElementById("shipping-charges")?.value) || 0;
      const adjustment = parseFloat(document.getElementById("adjustment")?.value) || 0;
      const total = subtotal + shipping + adjustment;
      
      document.getElementById("subtotal-display").textContent = `‚Çπ${subtotal.toFixed(2)}`;
      document.getElementById("total-display").textContent = `‚Çπ${total.toFixed(2)}`;
    }

    function saveEstimate(isDraft) {
      const customerId = document.getElementById("est-customer").value;
      const customer = state.resources.find(r => r.id === customerId);
      if (!customer) { alert("Please select a customer"); return; }

      const tbody = document.getElementById("items-tbody");
      const items = Array.from(tbody.querySelectorAll("tr")).map(tr => ({
        description: tr.querySelector(".item-description").value,
        quantity: parseFloat(tr.querySelector(".item-quantity").value) || 1,
        rate: parseFloat(tr.querySelector(".item-rate").value) || 0,
        discount: parseFloat(tr.querySelector(".item-discount").value) || 0,
        tax: parseFloat(tr.querySelector(".item-tax").value) || 0
      }));

      const subtotal = parseFloat(document.getElementById("subtotal-display").textContent.replace('‚Çπ', '')) || 0;
      const total = parseFloat(document.getElementById("total-display").textContent.replace('‚Çπ', '')) || 0;

      const estimate = {
        id: nextId(),
        customerId, customerName: customer.name,
        number: document.getElementById("est-number").value,
        reference: document.getElementById("est-reference").value,
        date: document.getElementById("est-date").value,
        items, subtotal, amount: total,
        shippingCharges: parseFloat(document.getElementById("shipping-charges").value) || 0,
        adjustment: parseFloat(document.getElementById("adjustment").value) || 0,
        terms: document.getElementById("est-terms").value,
        status: isDraft ? 'DRAFT' : 'INVOICED',
        createdAt: new Date().toISOString()
      };

      state.estimates.push(estimate);
      addActivity(`${isDraft ? 'Created draft' : 'Created'} estimate ${estimate.number} for ${customer.name}`, "Sales");
      alert(`‚úÖ Estimate ${isDraft ? 'saved as draft' : 'created and sent'} successfully!`);
      renderSalesEstimates();
    }

    function viewEstimate(id) {
      const est = state.estimates?.find(e => e.id === id);
      if (!est) return;

      const container = document.getElementById("sales-body");
      container.innerHTML = `
        <div class="card" style="max-width: 900px; margin: 0 auto;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="renderSalesEstimates()">‚Üê Back</button>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print</button>
            </div>
          </div>
          <div style="background: white; padding: 40px; border: 2px solid #dee2e6;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #4f46e5;">ESTIMATE</h1>
              <p style="color: #6c757d; font-size: 1.1rem;">${est.number}</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
              <div>
                <h4>Customer:</h4>
                <p><strong>${est.customerName}</strong></p>
                <p style="color: #6c757d;">Ref: ${est.reference || 'N/A'}</p>
              </div>
              <div style="text-align: right;">
                <p><strong>Date:</strong> ${formatDate(est.date)}</p>
                <p><strong>Status:</strong> <span class="status-pill status-pill--${est.status === 'DRAFT' ? 'pending' : 'completed'}">${est.status}</span></p>
              </div>
            </div>
            <table style="margin-bottom: 20px; border: 1px solid #dee2e6;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th>Description</th>
                  <th style="width: 80px;">Qty</th>
                  <th style="width: 100px;">Rate</th>
                  <th style="width: 100px;">Discount</th>
                  <th style="width: 80px;">Tax</th>
                  <th style="width: 120px;">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${est.items.map(item => {
                  const itemTotal = (item.quantity * item.rate - item.discount) * (1 + item.tax / 100);
                  return `
                    <tr>
                      <td>${item.description || '-'}</td>
                      <td style="text-align: center;">${item.quantity}</td>
                      <td style="text-align: right;">‚Çπ${item.rate.toFixed(2)}</td>
                      <td style="text-align: right;">‚Çπ${item.discount.toFixed(2)}</td>
                      <td style="text-align: right;">${item.tax}%</td>
                      <td style="text-align: right; font-weight: 600;">‚Çπ${itemTotal.toFixed(2)}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
            <div style="display: flex; justify-content: flex-end;">
              <div style="width: 350px;">
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                  <span>Subtotal:</span><span>‚Çπ${est.subtotal.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                  <span>Shipping:</span><span>‚Çπ${est.shippingCharges.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                  <span>Adjustment:</span><span>‚Çπ${est.adjustment.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 15px; font-size: 1.3rem; font-weight: bold; background: #f8f9fa; margin-top: 8px;">
                  <span>Total:</span><span style="color: #4f46e5;">‚Çπ${est.amount.toFixed(2)}</span>
                </div>
              </div>
            </div>
            ${est.terms ? `<div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #dee2e6;">
              <h4>Terms & Conditions:</h4>
              <p style="color: #6c757d; white-space: pre-wrap;">${est.terms}</p>
            </div>` : ''}
          </div>
        </div>
      `;
    }
    window.renderSalesEstimates = renderSalesEstimates;

    // SHARES
    function renderShares() {
      const list = document.getElementById('shares-list');
      if (!list) return;
      list.innerHTML = state.shares.length === 0 ?
        '<p style="color: #6c757d; padding: 20px; text-align: center;">No shared items</p>' :
        state.shares.map(s => `
          <div style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-top: 10px;">
            <div style="font-weight: 600;">${s.type}: ${s.name}</div>
            <div style="font-size: 0.85rem; color: #6c757d;">Shared on ${formatDate(s.sharedDate)}</div>
          </div>
        `).join('');
    }

    // Form submissions
    document.getElementById('form-resource').addEventListener('submit', (e) => {
      e.preventDefault();
      const resource = {
        id: nextId(),
        name: document.getElementById('resource-name').value,
        email: document.getElementById('resource-email').value,
        department: document.getElementById('resource-department').value,
        role: document.getElementById('resource-role').value
      };
      state.resources.push(resource);
      addActivity(`Added new resource: ${resource.name}`, "Resources");
      renderResources();
      closeModal('modal-resource');
      e.target.reset();
    });

    document.getElementById('form-project').addEventListener('submit', (e) => {
      e.preventDefault();
      const project = {
        id: nextId(),
        name: document.getElementById('project-name').value,
        status: document.getElementById('project-status').value,
        startDate: document.getElementById('project-start').value,
        endDate: document.getElementById('project-end').value
      };
      state.projects.push(project);
      addActivity(`Created new project: ${project.name}`, "Projects");
      renderProjects();
      closeModal('modal-project');
      e.target.reset();
    });

    document.getElementById('form-task').addEventListener('submit', (e) => {
      e.preventDefault();
      const task = {
        id: nextId(),
        name: document.getElementById('task-name').value,
        projectId: document.getElementById('task-project').value,
        status: document.getElementById('task-status').value,
        priority: document.getElementById('task-priority').value,
        dueDate: document.getElementById('task-due').value
      };
      state.tasks.push(task);
      addActivity(`Created new task: ${task.name}`, "Tasks");
      renderTasks();
      closeModal('modal-task');
      e.target.reset();
    });

    document.getElementById('form-assignment').addEventListener('submit', (e) => {
      e.preventDefault();
      const assignment = {
        id: nextId(),
        resourceId: document.getElementById('select-assign-resource').value,
        taskId: document.getElementById('assignment-task').value,
        assignedDate: new Date().toISOString()
      };
      state.assignments.push(assignment);
      const resource = state.resources.find(r => r.id === assignment.resourceId);
      const task = state.tasks.find(t => t.id === assignment.taskId);
      addActivity(`Assigned ${task?.name || 'task'} to ${resource?.name || 'resource'}`, "Assignments");
      renderAssignments();
      closeModal('modal-assignment');
      e.target.reset();
    });

    document.getElementById('btn-share').addEventListener('click', () => {
      const type = document.getElementById('share-type').value;
      const id = document.getElementById('select-individual-resource').value;
      if (!id) { alert('Please select an individual'); return; }
      
      const resource = state.resources.find(r => r.id === id);
      if (resource) {
        state.shares.push({
          id: nextId(),
          type: type,
          name: resource.name,
          sharedDate: new Date().toISOString()
        });
        addActivity(`Shared ${type} data with ${resource.name}`, "Shares");
        renderShares();
        alert('Data shared successfully!');
      }
    });

    // Button event listeners
    document.getElementById('btn-add-resource').addEventListener('click', () => openModal('modal-resource'));
    document.getElementById('btn-add-project').addEventListener('click', () => openModal('modal-project'));
    document.getElementById('btn-add-task').addEventListener('click', () => openModal('modal-task'));
    document.getElementById('btn-add-assignment').addEventListener('click', () => openModal('modal-assignment'));

    // Initialize
    setupMainNavigation();
    setupOperationsSubnav();
    renderResources();
    renderProjects();
    renderTasks();
    renderAssignments();
    renderDashboard();
    renderSalesEstimates();
    renderShares();
  </script> 
</body>
</html>